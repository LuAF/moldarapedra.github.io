<!DOCTYPE html>
<html lang="pt">
  <head>
    <meta charset="utf-8" />
    <title>Teste Intuitivo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body {
        margin: 0;
        padding: 1rem;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: #f5f5f5;
      }

      #mensagem {
        margin-bottom: 1rem;
        padding: 0.75rem 1rem;
        border-radius: 4px;
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeeba;
      }

      #quadro-teste {
        width: 100%;
        height: 80vh;
        border: 1px solid #ccc;
        border-radius: 4px;
        overflow: hidden;
        background: #ffffff;
      }

      @media (max-width: 600px) {
        #quadro-teste {
          height: 70vh;
        }
      }
    </style>
  </head>
  <body>
    <div id="mensagem">
      Este teste deve ser realizado sem sair desta página.
      Se mudar de aba ou de janela, o teste será automaticamente anulado.
    </div>

    <div id="quadro-teste">
      <!-- SUBSTITUA O SRC PELO LINK DO SEU TESTE INTUITIVO -->
      <iframe
        id="frame-intuitivo"
        src="https://tests.intuitivo.pt/publication/07fe4657-c59b-4792-bbaf-b953381f65ea"
        style="width: 100%; height: 100%; border: none"
      ></iframe>
    </div>

    <script>
      // Estado do teste
      let testeAnulado = false;

      const mensagem = document.getElementById("mensagem");
      const quadroTeste = document.getElementById("quadro-teste");

      function anularTeste(motivo) {
        if (testeAnulado) return;
        testeAnulado = true;

        // Remove o iframe e esconde o quadro
        quadroTeste.innerHTML = "";
        quadroTeste.style.display = "none";

        // Mostra mensagem de anulação
        mensagem.style.background = "#f8d7da";
        mensagem.style.color = "#721c24";
        mensagem.style.borderColor = "#f5c6cb";
        mensagem.textContent =
          "O teste foi ANULADO porque saiu desta página (" +
          motivo +
          "). Informe o professor.";
      }

      // ✅ 1) Aba deixou de estar visível (mudou de aba, minimizou, mudou de janela/app)
      document.addEventListener("visibilitychange", () => {
        if (testeAnulado) return;
        if (document.visibilityState === "hidden") {
          anularTeste("a aba/janela deixou de estar visível");
        }
      });

      // ✅ 2) Janela perdeu o foco (fallback). Pequeno atraso para não punir foco em inputs/iframe.
      window.addEventListener("blur", function () {
        if (testeAnulado) return;

        setTimeout(() => {
          // Se a aba não estiver visível OU o documento não tiver foco, então saiu mesmo
          const saiuDaPagina =
            document.visibilityState !== "visible" || !document.hasFocus();

          if (saiuDaPagina) {
            anularTeste("a janela perdeu foco");
          }
        }, 150);
      });

      // ✅ 3) Navegação/fecho da página (ex.: voltar atrás, fechar aba)
      window.addEventListener("pagehide", () => {
        if (testeAnulado) return;
        anularTeste("a página foi fechada ou navegou para fora");
      });
    </script>
  </body>
</html>
